name: Release-plz

on:
  push:
    branches: [main, master]
    tags: ["amg-v*"]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

concurrency:
  group: release-plz-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release-plz-release:
    name: Release-plz release
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.repository_owner == 'Cardosaum' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write
    steps:
      - name: Validate secrets
        run: |
          if [ -z "${{ secrets.CARGO_REGISTRY_TOKEN }}" ]; then
            echo "::error::CARGO_REGISTRY_TOKEN secret is required but not set"
            exit 1
          fi

      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5
        with:
          workspaces: "."

      - name: Verify build
        run: cargo check --release --all-features || (echo "::error::Build verification failed" && exit 1)

      - uses: release-plz/action@487eb7b5c085a664d5c5ca05f4159bd9b591182a
        with:
          command: release
        continue-on-error: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  release-plz-pr:
    name: Release-plz PR
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.repository_owner == 'Cardosaum' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write
      pull-requests: write
    concurrency:
      group: release-plz-pr-${{ github.ref }}
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5
        with:
          workspaces: "."

      - uses: release-plz/action@487eb7b5c085a664d5c5ca05f4159bd9b591182a
        with:
          command: release-pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-release-binaries:
    name: Build Release Binaries
    runs-on: ${{ matrix.os }}
    needs: release-plz-release
    timeout-minutes: 45
    if: startsWith(github.ref, 'refs/tags/amg-v') && github.repository_owner == 'Cardosaum'
    permissions:
      contents: write
    env:
      TARGET: ${{ matrix.target }}
      BINARY: ${{ matrix.binary-name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary-name: amg
          - os: macos-latest
            target: x86_64-apple-darwin
            binary-name: amg
          - os: macos-latest
            target: aarch64-apple-darwin
            binary-name: amg
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary-name: amg.exe
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7

      - run: rustup target add ${{ env.TARGET }}

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5
        with:
          workspaces: "."

      - run: cargo build --release --target ${{ env.TARGET }}

      - name: Verify binary exists
        run: |
          if [ ! -f "target/${{ env.TARGET }}/release/${{ env.BINARY }}" ]; then
            echo "::error::Binary not found: target/${{ env.TARGET }}/release/${{ env.BINARY }}"
            exit 1
          fi
        shell: bash
        if: matrix.os != 'windows-latest'

      - name: Verify binary exists
        run: |
          if (-not (Test-Path "target\${{ env.TARGET }}\release\${{ env.BINARY }}")) {
            Write-Error "Binary not found: target\${{ env.TARGET }}\release\${{ env.BINARY }}"
            exit 1
          }
        shell: pwsh
        if: matrix.os == 'windows-latest'

      - id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/amg-v}
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?(\+[a-zA-Z0-9.-]+)?$ ]]; then
            echo "::error::Invalid version format: $VERSION"
            exit 1
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
        shell: bash

      - name: Create archive
        run: |
          set -euo pipefail
          mkdir -p release
          cp "target/${{ env.TARGET }}/release/${{ env.BINARY }}" release/
          chmod +x "release/${{ env.BINARY }}"
          cd release && tar czf "../amg-${{ steps.version.outputs.version }}-${{ env.TARGET }}.tar.gz" *
          if [ ! -f "../amg-${{ steps.version.outputs.version }}-${{ env.TARGET }}.tar.gz" ]; then
            echo "::error::Archive creation failed"
            exit 1
          fi
        shell: bash
        if: matrix.os != 'windows-latest'

      - name: Create archive
        run: |
          $ErrorActionPreference = 'Stop'
          New-Item -ItemType Directory -Force -Path release | Out-Null
          Copy-Item "target\${{ env.TARGET }}\release\${{ env.BINARY }}" release\
          Set-Location release
          tar czf "..\amg-${{ steps.version.outputs.version }}-${{ env.TARGET }}.tar.gz" *
          Set-Location ..
          if (-not (Test-Path "amg-${{ steps.version.outputs.version }}-${{ env.TARGET }}.tar.gz")) {
            Write-Error "Archive creation failed"
            exit 1
          }
        shell: pwsh
        if: matrix.os == 'windows-latest'

      - name: Generate checksum
        run: |
          set -euo pipefail
          ARCHIVE="amg-${{ steps.version.outputs.version }}-${{ env.TARGET }}.tar.gz"
          if [ ! -f "$ARCHIVE" ]; then
            echo "::error::Archive not found: $ARCHIVE"
            exit 1
          fi
          if [ "${{ matrix.os }}" = "macos-latest" ]; then
            shasum -a 256 "$ARCHIVE" > "${ARCHIVE}.sha256"
          else
            sha256sum "$ARCHIVE" > "${ARCHIVE}.sha256"
          fi
          if [ ! -f "${ARCHIVE}.sha256" ]; then
            echo "::error::Checksum file creation failed"
            exit 1
          fi
        shell: bash
        if: matrix.os != 'windows-latest'

      - name: Generate checksum
        run: |
          $ErrorActionPreference = 'Stop'
          $archive = "amg-${{ steps.version.outputs.version }}-${{ env.TARGET }}.tar.gz"
          if (-not (Test-Path $archive)) {
            Write-Error "Archive not found: $archive"
            exit 1
          }
          $hash = (Get-FileHash -Path $archive -Algorithm SHA256).Hash.ToLower()
          "${hash}  ${archive}" | Out-File -FilePath "${archive}.sha256" -Encoding ASCII
          if (-not (Test-Path "${archive}.sha256")) {
            Write-Error "Checksum file creation failed"
            exit 1
          }
        shell: pwsh
        if: matrix.os == 'windows-latest'

      - name: Verify checksum
        run: |
          set -euo pipefail
          ARCHIVE="amg-${{ steps.version.outputs.version }}-${{ env.TARGET }}.tar.gz"
          if [ "${{ matrix.os }}" = "macos-latest" ]; then
            shasum -a 256 -c "${ARCHIVE}.sha256" || (echo "::error::Checksum verification failed" && exit 1)
          else
            sha256sum -c "${ARCHIVE}.sha256" || (echo "::error::Checksum verification failed" && exit 1)
          fi
        shell: bash
        if: matrix.os != 'windows-latest'

      - name: Verify checksum
        run: |
          $ErrorActionPreference = 'Stop'
          $archive = "amg-${{ steps.version.outputs.version }}-${{ env.TARGET }}.tar.gz"
          $expectedHash = (Get-Content "${archive}.sha256" | Select-Object -First 1).Split(' ')[0]
          $actualHash = (Get-FileHash -Path $archive -Algorithm SHA256).Hash.ToLower()
          if ($expectedHash -ne $actualHash) {
            Write-Error "Checksum verification failed"
            exit 1
          }
        shell: pwsh
        if: matrix.os == 'windows-latest'

      - uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
        with:
          files: |
            amg-${{ steps.version.outputs.version }}-${{ env.TARGET }}.tar.gz
            amg-${{ steps.version.outputs.version }}-${{ env.TARGET }}.tar.gz.sha256
        continue-on-error: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

