name: Release-plz

on:
  push:
    branches: [main, master]
    tags: ["amg-v*"]
  workflow_dispatch:

env:
  CARGO_TERM_COLOR: always

concurrency:
  group: release-plz-${{ github.ref }}
  cancel-in-progress: false

jobs:
  release-plz-release:
    name: Release-plz release
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: github.repository_owner == 'Cardosaum' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5
        with:
          workspaces: "."

      - uses: release-plz/action@487eb7b5c085a664d5c5ca05f4159bd9b591182a
        with:
          command: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  release-plz-pr:
    name: Release-plz PR
    runs-on: ubuntu-latest
    timeout-minutes: 15
    if: github.repository_owner == 'Cardosaum' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    permissions:
      contents: write
      pull-requests: write
    concurrency:
      group: release-plz-pr-${{ github.ref }}
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8
        with:
          fetch-depth: 0

      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5
        with:
          workspaces: "."

      - uses: release-plz/action@487eb7b5c085a664d5c5ca05f4159bd9b591182a
        with:
          command: release-pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-release-binaries:
    name: Build Release Binaries
    runs-on: ${{ matrix.os }}
    needs: release-plz-release
    timeout-minutes: 45
    if: startsWith(github.ref, 'refs/tags/amg-v') && github.repository_owner == 'Cardosaum'
    permissions:
      contents: write
    env:
      TARGET: ${{ matrix.target }}
      BINARY: ${{ matrix.binary-name }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            binary-name: amg
          - os: macos-latest
            target: x86_64-apple-darwin
            binary-name: amg
          - os: macos-latest
            target: aarch64-apple-darwin
            binary-name: amg
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            binary-name: amg.exe
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8

      - uses: dtolnay/rust-toolchain@4be9e76fd7c4901c61fb841f559994984270fce7

      - run: rustup target add ${{ env.TARGET }}

      - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5
        with:
          workspaces: "."

      - run: cargo build --release --target ${{ env.TARGET }}

      - id: version
        run: echo "version=${GITHUB_REF#refs/tags/amg-v}" >> $GITHUB_OUTPUT

      - name: Create archive
        run: |
          mkdir -p release
          cp target/${{ env.TARGET }}/release/${{ env.BINARY }} release/
          chmod +x release/${{ env.BINARY }}
          cd release && tar czf ../amg-${{ steps.version.outputs.version }}-${{ env.TARGET }}.tar.gz *
        shell: bash
        if: matrix.os != 'windows-latest'

      - name: Create archive
        run: |
          mkdir release
          copy target\${{ env.TARGET }}\release\${{ env.BINARY }} release\
          cd release && tar czf ..\amg-${{ steps.version.outputs.version }}-${{ env.TARGET }}.tar.gz *
        shell: cmd
        if: matrix.os == 'windows-latest'

      - name: Generate checksum
        run: |
          if [ "${{ matrix.os }}" = "macos-latest" ]; then
            shasum -a 256 amg-${{ steps.version.outputs.version }}-${{ env.TARGET }}.tar.gz > amg-${{ steps.version.outputs.version }}-${{ env.TARGET }}.tar.gz.sha256
          else
            sha256sum amg-${{ steps.version.outputs.version }}-${{ env.TARGET }}.tar.gz > amg-${{ steps.version.outputs.version }}-${{ env.TARGET }}.tar.gz.sha256
          fi
        shell: bash
        if: matrix.os != 'windows-latest'

      - name: Generate checksum
        run: |
          $hash = (Get-FileHash -Path amg-${{ steps.version.outputs.version }}-${{ env.TARGET }}.tar.gz -Algorithm SHA256).Hash.ToLower()
          "$hash  amg-${{ steps.version.outputs.version }}-${{ env.TARGET }}.tar.gz" | Out-File -FilePath amg-${{ steps.version.outputs.version }}-${{ env.TARGET }}.tar.gz.sha256 -Encoding ASCII
        shell: pwsh
        if: matrix.os == 'windows-latest'

      - uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b
        with:
          files: |
            amg-${{ steps.version.outputs.version }}-${{ env.TARGET }}.tar.gz
            amg-${{ steps.version.outputs.version }}-${{ env.TARGET }}.tar.gz.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

